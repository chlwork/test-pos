<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>市集行動 POS 系統</title>
    
    <!-- PWA 與 行動端優化標籤 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="市集POS">
    <meta name="theme-color" content="#4338ca">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        :root {
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f1f5f9;
            overscroll-behavior-y: contain;
            -webkit-tap-highlight-color: transparent;
        }

        .product-card:active {
            transform: scale(0.92);
            background-color: #e2e8f0;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @media (max-width: 767px) {
            #view-cart {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 40;
                height: 75vh;
                transform: translateY(calc(75vh - 64px));
                transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.1);
                border-radius: 24px 24px 0 0;
            }
            #view-cart.expanded {
                transform: translateY(0);
            }
            .drawer-handle { display: block; }
        }
        
        @media (min-width: 768px) {
            #view-cart { height: auto; transform: none !important; border-radius: 0; }
            .drawer-handle { display: none; }
        }

        .pb-safe { padding-bottom: calc(1rem + var(--safe-area-inset-bottom)); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <header class="bg-indigo-700 text-white p-4 shadow-lg flex justify-between items-center shrink-0 z-20 pt-[calc(1rem+env(safe-area-inset-top))]">
        <h1 class="text-lg font-bold flex items-center gap-2">
            <i data-lucide="store" class="w-5 h-5"></i> 
            <span>市集 POS</span>
        </h1>
        <nav class="flex bg-indigo-800 rounded-lg p-1">
            <button onclick="switchTab('pos')" id="tab-pos" class="px-3 py-1.5 rounded-md text-sm font-medium transition bg-indigo-600 shadow">
                點餐
            </button>
            <button onclick="switchTab('history')" id="tab-history" class="px-3 py-1.5 rounded-md text-sm font-medium transition">
                營收
            </button>
            <button onclick="switchTab('settings')" id="tab-settings" class="px-3 py-1.5 rounded-md text-sm font-medium transition">
                管理
            </button>
        </nav>
    </header>

    <main class="flex-1 relative overflow-hidden bg-gray-100 flex flex-col md:flex-row">
        <div class="flex-1 relative flex flex-col overflow-hidden">
            <section id="view-pos" class="view-section flex-1 p-3 overflow-y-auto no-scrollbar space-y-6">
                <div id="product-list-container"></div>
                <div class="h-32 md:hidden"></div>
            </section>

            <section id="view-history" class="view-section hidden flex-1 p-4 overflow-y-auto no-scrollbar">
                <div class="max-w-2xl mx-auto space-y-4">
                    <div class="flex justify-between items-end">
                        <h2 class="text-xl font-bold">銷售紀錄</h2>
                        <button onclick="clearHistory()" class="text-xs text-red-400">清除紀錄</button>
                    </div>
                    <div class="bg-indigo-700 text-white p-6 rounded-3xl shadow-lg">
                        <div class="text-indigo-200 text-sm">今日累計營收</div>
                        <div class="text-4xl font-black font-mono mt-1" id="history-total-revenue">$ 0</div>
                        <div class="text-xs mt-2 opacity-70" id="history-count">共 0 筆交易</div>
                    </div>
                    <div id="history-list" class="space-y-3"></div>
                </div>
            </section>

            <section id="view-settings" class="view-section hidden flex-1 p-4 overflow-y-auto no-scrollbar">
                <div class="max-w-2xl mx-auto space-y-6">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="font-bold mb-4 flex items-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5 text-green-500"></i> 新增商品</h3>
                        <div class="space-y-3">
                            <div class="flex gap-2">
                                <input type="text" id="new-p-name" placeholder="名稱" class="flex-1 border-2 border-gray-100 p-3 rounded-xl outline-none focus:border-green-500">
                                <input type="number" id="new-p-price" placeholder="價格" class="w-24 border-2 border-gray-100 p-3 rounded-xl outline-none focus:border-green-500" inputmode="numeric">
                            </div>
                            <div class="flex gap-2">
                                <select id="new-p-category" class="flex-1 border-2 border-gray-100 p-3 rounded-xl bg-white">
                                    <option value="預設群組">預設群組</option>
                                    <option value="飲品">飲品</option>
                                    <option value="甜點">甜點</option>
                                    <option value="custom">+ 自定義群組</option>
                                </select>
                                <input type="text" id="custom-category" placeholder="新群組名稱" class="hidden flex-1 border-2 border-gray-100 p-3 rounded-xl outline-none focus:border-green-500">
                                <button onclick="addProduct()" class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold shrink-0">新增</button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-4 bg-gray-50 border-b font-bold">商品管理</div>
                        <div id="settings-list" class="divide-y divide-gray-100"></div>
                    </div>
                </div>
            </section>
        </div>

        <aside id="view-cart" class="flex w-full md:w-96 bg-white border-l border-gray-200 flex-col shadow-[0_-10px_30px_-15px_rgba(0,0,0,0.3)] md:shadow-xl">
            <div onclick="toggleCart()" class="drawer-handle w-full py-2 bg-white flex flex-col items-center cursor-pointer border-b">
                <div class="w-12 h-1.5 bg-gray-200 rounded-full mb-2"></div>
                <div class="flex items-center gap-2 text-indigo-700 font-bold">
                    <i data-lucide="receipt-text" class="w-4 h-4"></i>
                    <span>結帳明細</span>
                    <span id="cart-count-badge" class="bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full">0</span>
                </div>
            </div>

            <div class="hidden md:flex p-4 border-b justify-between items-center bg-white">
                <h2 class="font-bold text-lg text-indigo-700">明細清單</h2>
                <button onclick="clearCart()" class="text-gray-400 text-sm">清空</button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar" id="cart-items"></div>

            <div class="p-4 bg-gray-50 border-t space-y-4 pb-safe">
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500">總計金額</span>
                        <span id="total-amount" class="text-2xl font-bold text-indigo-600">$ 0</span>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="relative">
                            <span class="absolute left-3 top-1 text-[10px] text-gray-400">實收</span>
                            <input type="number" id="cash-received" oninput="calculateChange()" class="w-full bg-white border-2 border-gray-200 pt-5 pb-2 px-3 rounded-xl text-lg font-mono outline-none" inputmode="numeric" placeholder="0">
                        </div>
                        <div class="relative bg-gray-100 rounded-xl px-3 pt-5 pb-2">
                            <span class="absolute left-3 top-1 text-[10px] text-gray-400">找零</span>
                            <div id="change-amount" class="text-lg font-mono text-red-500 font-bold">$ 0</div>
                        </div>
                    </div>
                </div>
                <button onclick="checkout()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl text-xl font-bold shadow-lg active:scale-95 transition-all">
                    結帳完成
                </button>
            </div>
        </aside>
    </main>

    <div id="success-modal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center p-6 z-50 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-3xl max-w-sm w-full text-center space-y-6">
            <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto">
                <i data-lucide="check" size="40"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800">結帳完成</h3>
            <p class="text-gray-500" id="modal-summary"></p>
            <button onclick="closeModal()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold">接待下位客戶</button>
        </div>
    </div>

    <script>
        let products = JSON.parse(localStorage.getItem('pos_products')) || [
            { id: 1, name: '招牌咖啡', price: 120, category: '飲品' },
            { id: 2, name: '精品手沖', price: 150, category: '飲品' },
            { id: 3, name: '巧克力蛋糕', price: 80, category: '甜點' }
        ];
        let salesHistory = JSON.parse(localStorage.getItem('pos_history')) || [];
        let cart = [];

        window.onload = () => {
            renderProducts();
            renderSettings();
            renderHistory();
            updateCartBadge();
            
            document.getElementById('new-p-category').addEventListener('change', (e) => {
                const customInput = document.getElementById('custom-category');
                if (e.target.value === 'custom') {
                    customInput.classList.remove('hidden');
                    e.target.classList.add('hidden');
                    customInput.focus();
                }
            });
            lucide.createIcons();
        };

        function switchTab(tab) {
            document.querySelectorAll('.view-section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('bg-indigo-600', 'shadow'));
            document.getElementById(`tab-${tab}`).classList.add('bg-indigo-600', 'shadow');

            const cartEl = document.getElementById('view-cart');
            (tab === 'pos') ? cartEl.classList.add('flex') : cartEl.classList.remove('flex', 'hidden');
            if (tab !== 'pos') cartEl.classList.add('hidden');

            if(tab === 'history') renderHistory();
            lucide.createIcons();
        }

        function toggleCart() {
            document.getElementById('view-cart').classList.toggle('expanded');
        }

        function renderProducts() {
            const container = document.getElementById('product-list-container');
            container.innerHTML = '';
            const groups = products.reduce((acc, p) => {
                const cat = p.category || '預設';
                if (!acc[cat]) acc[cat] = [];
                acc[cat].push(p);
                return acc;
            }, {});

            Object.keys(groups).sort().forEach(group => {
                const section = document.createElement('div');
                section.className = 'mb-6';
                section.innerHTML = `
                    <h3 class="text-xs font-bold text-gray-400 mb-2 px-1 uppercase tracking-wider">${group}</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
                        ${groups[group].map(p => `
                            <button onclick="addToCart(${p.id})" class="product-card bg-white p-4 h-24 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center transition-all">
                                <span class="text-sm font-bold text-gray-700">${p.name}</span>
                                <span class="text-indigo-600 font-mono font-bold">$${p.price}</span>
                            </button>
                        `).join('')}
                    </div>
                `;
                container.appendChild(section);
            });
            lucide.createIcons();
        }

        function addToCart(pid) {
            const prod = products.find(p => p.id === pid);
            const item = cart.find(i => i.id === pid);
            if (item) item.qty++;
            else cart.push({ ...prod, qty: 1 });
            if (navigator.vibrate) navigator.vibrate(10);
            renderCart();
            updateCartBadge();
        }

        function removeFromCart(id) {
            cart = cart.filter(i => i.id !== id);
            renderCart();
            updateCartBadge();
        }

        function updateQty(id, delta) {
            const item = cart.find(i => i.id === id);
            if (item) {
                item.qty += delta;
                if (item.qty <= 0) cart = cart.filter(i => i.id !== id);
            }
            renderCart();
            updateCartBadge();
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            if (cart.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-gray-300">明細為空</div>';
                document.getElementById('total-amount').innerText = '$ 0';
                return;
            }
            let total = 0;
            container.innerHTML = cart.map(item => {
                const sub = item.price * item.qty;
                total += sub;
                return `
                    <div class="flex items-center gap-3 bg-gray-50 p-3 rounded-2xl border border-gray-100">
                        <div class="flex-1 min-w-0">
                            <div class="font-bold text-sm truncate">${item.name}</div>
                            <div class="text-[10px] text-gray-400">$${item.price}</div>
                        </div>
                        <div class="flex items-center bg-white rounded-lg border border-gray-200">
                            <button onclick="updateQty(${item.id}, -1)" class="w-8 h-8 font-bold">-</button>
                            <span class="w-6 text-center font-mono text-xs">${item.qty}</span>
                            <button onclick="updateQty(${item.id}, 1)" class="w-8 h-8 font-bold">+</button>
                        </div>
                        <div class="w-12 text-right font-bold text-gray-700 font-mono text-xs">$${sub}</div>
                        <button onclick="removeFromCart(${item.id})" class="text-red-300 p-1 hover:text-red-500">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
            }).join('');
            document.getElementById('total-amount').innerText = `$ ${total}`;
            calculateChange();
            lucide.createIcons();
        }

        function calculateChange() {
            const total = parseInt(document.getElementById('total-amount').innerText.replace('$ ', '')) || 0;
            const received = parseInt(document.getElementById('cash-received').value) || 0;
            const changeBox = document.getElementById('change-amount');
            if (received >= total && total > 0) {
                changeBox.innerText = `$ ${received - total}`;
                changeBox.className = "text-lg font-mono text-green-600 font-bold";
            } else {
                changeBox.innerText = `$ 0`;
                changeBox.className = "text-lg font-mono text-red-500 font-bold";
            }
        }

        function checkout() {
            const total = parseInt(document.getElementById('total-amount').innerText.replace('$ ', '')) || 0;
            if (total === 0) return;
            const received = parseInt(document.getElementById('cash-received').value) || 0;
            if (received < total) { alert('實收金額不足'); return; }

            const record = {
                id: Date.now(),
                time: new Date().toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit' }),
                items: cart.map(i => `${i.name}x${i.qty}`).join(', '),
                total: total
            };
            salesHistory.unshift(record);
            localStorage.setItem('pos_history', JSON.stringify(salesHistory));

            document.getElementById('modal-summary').innerText = `收 $${received}，找 $${received - total}`;
            document.getElementById('success-modal').classList.remove('hidden');
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            let totalRev = 0;
            list.innerHTML = salesHistory.map(h => {
                totalRev += h.total;
                return `
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center">
                        <div class="min-w-0 flex-1">
                            <div class="text-xs text-gray-400">${h.time}</div>
                            <div class="text-sm font-bold truncate">${h.items}</div>
                        </div>
                        <div class="font-mono font-black text-indigo-600 ml-4">$${h.total}</div>
                    </div>
                `;
            }).join('');
            document.getElementById('history-total-revenue').innerText = `$ ${totalRev}`;
            document.getElementById('history-count').innerText = `今日交易筆數: ${salesHistory.length}`;
        }

        function clearHistory() { if(confirm('清除今日所有紀錄？')) { salesHistory=[]; localStorage.setItem('pos_history', JSON.stringify([])); renderHistory(); } }
        function updateCartBadge() { document.getElementById('cart-count-badge').innerText = cart.reduce((s, i) => s + i.qty, 0); }
        function clearCart() { cart = []; document.getElementById('cash-received').value = ''; renderCart(); updateCartBadge(); }
        function closeModal() { document.getElementById('success-modal').classList.add('hidden'); clearCart(); }

        function renderSettings() {
            const list = document.getElementById('settings-list');
            list.innerHTML = products.map(p => `
                <div class="flex items-center justify-between p-4">
                    <div>
                        <div class="font-bold">${p.name}</div>
                        <div class="text-xs text-gray-400">${p.category} • $${p.price}</div>
                    </div>
                    <button onclick="deleteProduct(${p.id})" class="text-red-400 p-2"><i data-lucide="trash-2" size="18"></i></button>
                </div>
            `).join('');
            localStorage.setItem('pos_products', JSON.stringify(products));
            lucide.createIcons();
        }

        function addProduct() {
            const n = document.getElementById('new-p-name'), p = document.getElementById('new-p-price'), c = document.getElementById('new-p-category'), cc = document.getElementById('custom-category');
            let cat = (c.value === 'custom') ? cc.value : c.value;
            if (n.value && p.value >= 0) {
                products.push({ id: Date.now(), name: n.value, price: parseInt(p.value), category: cat || '未分類' });
                n.value = ''; p.value = ''; cc.value = ''; cc.classList.add('hidden'); c.classList.remove('hidden');
                renderProducts(); renderSettings();
            }
        }
        function deleteProduct(id) { products = products.filter(p => p.id !== id); renderProducts(); renderSettings(); }
    </script>
</body>
</html>